description: >
  Fetch GitHub Token as GITHUB_APP_TOKEN
parameters:
  app_id:
    type: string
    description: "ID of the GitHub App"
  installation_id:
    type: string
    description: "The ID of the installation for which the token will be requested (defaults to the ID of the repository's installation)"
  base64_private_key:
    type: string
    description: "Base64 encoded Private key of the GitHub App"
  env_name:
    type: string
    default: GITHUB_APP_TOKEN
    description: "Enable to Customize Token ENV Name"
  repository_name:
    type: string
    default: ""
    description: "GitHub Repository Name"
steps:
  - run:
      name: Fetch GitHub Token
      command: |
        b64url() {
          openssl base64 -e -A | tr '+' '-' | tr '/' '_' | tr -d '='
        }

        header=$(echo -n '{"alg":"RS256","typ":"JWT"}' | b64url)

        now=$(date "+%s")
        iat=$((${now} - 60))
        exp=$((${now} + (30 * 60)))  # Expires after 30 mins
        payload=$(echo -n "{\"iat\":${iat},\"exp\":${exp},\"iss\":\"<< parameters.app_id >>\"}" | b64url)

        unsigned_token="${header}.${payload}"
        signed_token=$(echo -n "${unsigned_token}" | openssl dgst -sha256 -sign <(echo "<< parameters.base64_private_key >>" | base64 -d) | b64url)

        jwt="${unsigned_token}.${signed_token}"

        installation_token=$(
          curl -s -X POST \
            -H "Authorization: Bearer ${jwt}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/app/installations/<< parameters.installation_id >>/access_tokens" \
            $([[ -n "<< parameters.repository_name >>" ]] && echo "-d '{"repository":"<< parameters.repository_name >>"}'" || echo "") \
          | awk -F'"' '/"token"/ {print $4}' | tr -d '[:space:]'
        )
        echo "export << parameters.env_name >>=${installation_token}" >> $BASH_ENV
        data=$(curl -sS -f -H "Authorization: Bearer $installation_token" -H "Accept: application/vnd.github+json" https://api.github.com/installation/repositories)
        if [ $? -eq 0 ]; then
          printf "Token created with access to:\n%s\n" "$(echo $data)"
          echo
        else
          echo "Failed to access GitHub with token"
          exit 1
        fi
